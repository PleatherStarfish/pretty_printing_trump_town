<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Timeline with Integers</title>
  <meta charset="utf-8" />
</head>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.16/d3.min.js" charset="utf-8" type="text/javascript"></script>
<script src="data.js" type="text/javascript"></script>


<body>

  <script>

  const dataset_test = [[15, 13, 0], [12, 31, 1], [91, 99, 1]]

  const dataset = {
    "17": {
      "agency_name": "U.S. Trade Representative",
      "agency_slug": "u-s-trade-representative",
      "positions": {
        "Senior Advisor, Office of the Ambassador": [
          {
            "staffer_id": 396,
            "name": "Yecheil David Feit",
            "start_date": 14.0,
            "end_date": NaN
          }
        ]
    }
  },
  "24": {
    "agency_name": "Education",
    "agency_slug": "education",
    "positions": {
      "Senior Admin": [
        {
          "staffer_id": 100,
          "name": "Dane Torkai",
          "start_date": 25.0,
          "end_date": 56.0
        }
      ]
  }
}
}

// ([key, value]) => (
//     svg.selectAll("rect")
//        .data(value)
//        .enter()
//        .append("rect")
//        .attr("x", (d, i) => linearScale(value[0]["start_date"] ? value[0]["start_date"] : 1169269200))
//        .attr("y", (d, i) => i * (minBarThickness + padding))
//        .attr("height", minBarThickness)
//        .attr("width", (d, i) => linearScale(value[0]["end_date"] ? value[0]["end_date"] : 1530331200))
//        .attr("fill", "grey")
//      )


  const w               = 11150;
  const h               = 11150;
  const padding         = 15;
  const minBarThickness = 5;

  let y_index = 0;

  function log(sel,msg) {
    console.log(msg,sel);
  }

  function barCluster(agency) {
    for (let position in agency["positions"]) {

      for (person in agency["positions"][position]) {

        const one_person = agency["positions"][position][person];

        // convert date format
        !one_person.start_date ? one_person.start_date : one_person.start_date = new Date(one_person.start_date);
        !one_person.end_date ? one_person.end_date : one_person.end_date = new Date(one_person.end_date);

        const start_x = linearScale(one_person.start_date ? one_person.start_date : new Date(1169269200));
        const end_x = linearScale(one_person.end_date ? one_person.end_date : new Date(1530331200));


        let bars = svg.selectAll(null)
           .data([one_person])
           .enter()
           .append("g")

        bars.append("rect")
           .attr("x", start_x)
           .attr("y", y_index * (minBarThickness + padding))
           .attr("height", minBarThickness)
           .attr("width", end_x - start_x)
           .attr("fill", "grey");

        bars.append("text")
            .attr("x", end_x)
            .attr("y", y_index * (minBarThickness + padding))
            .text((d) => d.name);

        y_index += 1;
      }

    }
  }

  const svg = d3.select("body")
                .append("svg")
                .attr("width", w)
                .attr("height", h);

  // [1169269200, 1530331200]

  const linearScale = d3.time.scale()
                .domain([new Date(1169269200), new Date(1530331200)])
                .range([0, 1150]);

  // Get object back one agency at a time.
  Object.entries(data).forEach(
    ([key, value]) => barCluster(value)
  );


  // svg.selectAll("rect")
  //    .data(dataset_test)
  //    .enter()
  //    .append("rect")
  //    .attr("x", (d, i) => linearScale(d[0]))
  //    .attr("y", (d, i) => d[2] * (minBarThickness + padding))
  //    .attr("height", minBarThickness)
  //    .attr("width", (d) => linearScale(d[1]))
  //    .attr("fill", "grey");

  </script>

</body>
</html>
